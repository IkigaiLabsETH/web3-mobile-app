name: Mobile Dev Action iOS

defaults:
  run:
    working-directory: apps/expo
on:
  pull_request:
    branches: ["staging"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18.x
          cache: yarn
      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: Install dependencies
        run: yarn install --frozen-lockfile
      - name: Build on EAS
        run: |
            BUILD_OUTPUT=$(STAGE=development eas build --profile simulator --platform ios) \
            # Check for successful build                                                   \
            if echo "$BUILD_OUTPUT" | grep -q "âœ” Build finished"; then                     \
              # Extract the URL of the iOS app                                             \
              DOWNLOAD_URL=$(echo "$BUILD_OUTPUT" | grep -Eo 'https://expo\.dev/artifacts/eas/[A-Za-z0-9]+/[A-Za-z0-9]+\.tar\.gz') \
              echo "APP_DIR_PATH=${DOWNLOAD_URL}" >>$GITHUB_ENV  \
              echo "done!" \
            fi

      - uses: mobile-dev-inc/action-maestro-cloud@v1.1.1
        with:
          api-key: ${{ secrets.MAESTRO_CLOUD_API_KEY }}
          app-file: ${{ env.APP_DIR_PATH }}
          env: |
            PLATFORM=ios
